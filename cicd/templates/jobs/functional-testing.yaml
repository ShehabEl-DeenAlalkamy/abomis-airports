parameters:
  - name: jobName
    type: string
    default: FuncTesting
  - name: displayName
    type: string
    default: Functional Testing
  - name: artifactAlias
    type: string
  - name: artifactName
    type: string
  - name: dependsOn
    type: object
    default: []
  - name: mandatoryTasks
    type: stepList
    default: []

jobs:
  - job: ${{ parameters.jobName }}
    displayName: ${{ parameters.displayName }}
    dependsOn:
      - ${{ each dependency in parameters.dependsOn }}:
          - ${{ dependency }}
    steps:
      - ${{ parameters.mandatoryTasks }}

      - template: ../steps/export-scripts-path.yaml
        parameters:
          isReleaseFlow: true

      - download: ${{ parameters.artifactAlias }}
        artifact: ${{ parameters.artifactName }}
        displayName: Download ${{ parameters.artifactName }}

      - task: CopyFiles@2
        displayName: Copy Artifacts to Build Sources Directory
        inputs:
          SourceFolder: $(Pipeline.Workspace)/${{ parameters.artifactAlias }}/${{ parameters.artifactName }}
          Contents: "**"
          TargetFolder: $(Build.SourcesDirectory)
          OverWrite: true

      - task: NodeTool@0
        displayName: "Install Node 18.0.0"
        inputs:
          versionSpec: 18.0.0

      - task: Npm@1
        displayName: "npm install"
        inputs:
          verbose: false

      - bash: |
          readonly ADO_DEBUG_CMD="##[debug]"
          echo "${ADO_DEBUG_CMD}"creating "${BUILD_ARTIFACTSTAGINGDIRECTORY}"/functional-testing/cucumber     
          mkdir -p "${BUILD_ARTIFACTSTAGINGDIRECTORY}"/functional-testing/cucumber
          echo "TEST_HOST=${HOSTNAME} node node_modules/.bin/cucumber-js --publish-quiet "${PATH_TO_TARGET}"/test/integration --format json:"${BUILD_ARTIFACTSTAGINGDIRECTORY}"/functional-testing/cucumber/reports.json"
          TEST_HOST="${HOSTNAME}" node node_modules/.bin/cucumber-js --publish-quiet "${PATH_TO_TARGET}"/test/integration --format json:"${BUILD_ARTIFACTSTAGINGDIRECTORY}"/functional-testing/cucumber/reports.json
        displayName: "FT: CucumberJS"
        env:
          PATH_TO_TARGET: $(Build.SourcesDirectory)/target

      - task: PublishBuildArtifacts@1
        displayName: "Publish: Functional Tests Results"
        inputs:
          pathToPublish: $(Build.ArtifactStagingDirectory)/functional-testing
          artifactName: functional-testing-$(env)

      - bash: |
          readonly ADO_DEBUG_CMD="##[debug]"
          echo "${ADO_DEBUG_CMD}"deleting "${BUILD_ARTIFACTSTAGINGDIRECTORY}"/functional-testing.
          rm -rf "${BUILD_ARTIFACTSTAGINGDIRECTORY}"/functional-testing
        displayName: Artifacts Cleaning
